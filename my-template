AWSTemplateFormatVersion: 2010-09-09
Description: Cloud Formation Demo Stack
Metadata:
  Version: v1.0
  Comments: Generated by Miztiik
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - CidrBlock
          - pubAvailabilityZone
          - pubSubnetCIDR
          - privAvailabilityZone
          - privSubnetCIDR
      - Label:
          default: EC2 Instances Configuration
        Parameters:
          - InstanceName
          - InstanceType
          - Environment
      - Label:
          default: RDS Instance Configuration
        Parameters:
          - DBInstanceId
          - DBName
          - DBEngine
          - DBUserName
          - DBUserPass
          - DBStorage
          - DBInstanceClass
  'AWS::CloudFormation::Designer':
    a8c917ec-ee69-4d4c-a528-c62c4996d5ec:
      size:
        width: 60
        height: 60
      position:
        x: 810
        'y': 390
      z: 1
      embeds: []
    e4f7936a-400a-4d5c-95f5-f806e02f2c22:
      size:
        width: 690
        height: 690
      position:
        x: 210
        'y': 140
      z: 1
      embeds:
        - 9f2904d4-266b-42c3-8399-76d965243f04
        - 7568faca-cd6b-4340-a8fb-b0911c92c760
        - fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
        - 82ca94fc-931b-4a58-b519-765807f6247c
        - f6688c2b-e6a2-4754-aecc-2c74383a9cba
    9f2904d4-266b-42c3-8399-76d965243f04:
      size:
        width: 60
        height: 60
      position:
        x: 630
        'y': 200
      z: 2
      parent: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      embeds: []
      iscontainedinside:
        - e4f7936a-400a-4d5c-95f5-f806e02f2c22
    7568faca-cd6b-4340-a8fb-b0911c92c760:
      size:
        width: 60
        height: 60
      position:
        x: 750
        'y': 200
      z: 2
      parent: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      embeds: []
      iscontainedinside:
        - e4f7936a-400a-4d5c-95f5-f806e02f2c22
    aa6894cb-4e89-4a33-bb6a-98a255dbebd4:
      source:
        id: 7568faca-cd6b-4340-a8fb-b0911c92c760
      target:
        id: 9f2904d4-266b-42c3-8399-76d965243f04
    fbe3d8f8-2eab-4167-9f63-026ed5fdaa14:
      size:
        width: 330
        height: 240
      position:
        x: 240
        'y': 200
      z: 2
      parent: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      embeds:
        - 8c42d760-4a2b-45a0-9eeb-8a9398ef764d
        - fdc57ba6-658d-4271-824b-7c33022144e8
      iscontainedinside:
        - e4f7936a-400a-4d5c-95f5-f806e02f2c22
    8c42d760-4a2b-45a0-9eeb-8a9398ef764d:
      size:
        width: 60
        height: 60
      position:
        x: 270
        'y': 260
      z: 3
      parent: fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
      embeds: []
      isassociatedwith:
        - 9f2904d4-266b-42c3-8399-76d965243f04
      iscontainedinside:
        - fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
    fdc57ba6-658d-4271-824b-7c33022144e8:
      size:
        width: 60
        height: 60
      position:
        x: 390
        'y': 260
      z: 3
      parent: fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
      embeds: []
      isassociatedwith:
        - 9f2904d4-266b-42c3-8399-76d965243f04
      iscontainedinside:
        - fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
    82ca94fc-931b-4a58-b519-765807f6247c:
      size:
        width: 240
        height: 240
      position:
        x: 540
        'y': 500
      z: 2
      parent: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      embeds:
        - da5c168f-8660-4399-a08f-5f2b48d85a7d
      iscontainedinside:
        - e4f7936a-400a-4d5c-95f5-f806e02f2c22
    da5c168f-8660-4399-a08f-5f2b48d85a7d:
      size:
        width: 60
        height: 60
      position:
        x: 570
        'y': 560
      z: 3
      parent: 82ca94fc-931b-4a58-b519-765807f6247c
      embeds: []
      isassociatedwith:
        - 7568faca-cd6b-4340-a8fb-b0911c92c760
      iscontainedinside:
        - 82ca94fc-931b-4a58-b519-765807f6247c
    aaff044f-027d-4278-ab17-57f9b88318ed:
      size:
        width: 240
        height: 240
      position:
        x: 810
        'y': 90
      z: 1
      embeds:
        - 89d54c05-7b80-4786-812a-93baea22e268
      iscontainedinside:
        - fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
        - 82ca94fc-931b-4a58-b519-765807f6247c
    89d54c05-7b80-4786-812a-93baea22e268:
      size:
        width: 60
        height: 60
      position:
        x: 840
        'y': 150
      z: 2
      parent: aaff044f-027d-4278-ab17-57f9b88318ed
      embeds: []
      isassociatedwith:
        - 9f2904d4-266b-42c3-8399-76d965243f04
      iscontainedinside:
        - aaff044f-027d-4278-ab17-57f9b88318ed
    f6688c2b-e6a2-4754-aecc-2c74383a9cba:
      size:
        width: 240
        height: 240
      position:
        x: 240
        'y': 500
      z: 2
      parent: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      embeds:
        - 239ce74a-8b21-4a92-b954-63ab3f391083
      iscontainedinside:
        - e4f7936a-400a-4d5c-95f5-f806e02f2c22
    b3d2b830-2575-40cc-a9b3-352ffff45f9a:
      source:
        id: f6688c2b-e6a2-4754-aecc-2c74383a9cba
      target:
        id: fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
    d32ea858-5c74-4048-b38f-e4cfbfd90195:
      source:
        id: f6688c2b-e6a2-4754-aecc-2c74383a9cba
      target:
        id: 82ca94fc-931b-4a58-b519-765807f6247c
    239ce74a-8b21-4a92-b954-63ab3f391083:
      size:
        width: 60
        height: 60
      position:
        x: 270
        'y': 560
      z: 3
      parent: f6688c2b-e6a2-4754-aecc-2c74383a9cba
      embeds: []
      isassociatedwith:
        - a8c917ec-ee69-4d4c-a528-c62c4996d5ec
      iscontainedinside:
        - f6688c2b-e6a2-4754-aecc-2c74383a9cba
    e21978dd-2217-4279-8b14-5f9046bd5511:
      source:
        id: e4f7936a-400a-4d5c-95f5-f806e02f2c22
      target:
        id: a8c917ec-ee69-4d4c-a528-c62c4996d5ec
Parameters:
  CidrBlock:
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: 10.10.12.0/24
    Description: VPC CIDR Block (eg 10.0.0.0/16)
    Type: String
  pubAvailabilityZone:
    Description: The AvailabilityZone to use for the first subnet
    Type: 'AWS::EC2::AvailabilityZone::Name'
  pubSubnetCIDR:
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: 10.10.12.0/25
    Description: VPC CIDR Block for the Public Subnet (eg 10.0.0.0/24)
    Type: String
  privAvailabilityZone:
    Description: The AvailabilityZone to use for the second subnet
    Type: 'AWS::EC2::AvailabilityZone::Name'
  privSubnetCIDR:
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: 10.10.12.128/25
    Description: VPC CIDR Block for the Public Subnet (eg 10.0.0.0/24)
    Type: String
  InstanceName:
    Type: String
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
    ConstraintDescription: must be a valid EC2 instance type.
  KeyName:
    Description: The EC2 Key Pair to allow SSH access to the instances
    Type: 'AWS::EC2::KeyPair::KeyName'
    Default: region-virginia-training-demo-key
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  Environment:
    Description: >-
      Application environment for which this network is being created. e.g.
      Development/Production.
    Type: String
    Default: UAT
    AllowedValues:
      - UAT
      - DEV
      - QA
      - PROD
  InstancePublicIP:
    Description: >-
      Specifies whether to launch instances with public IP addresses in your
      VPC.
    Type: String
    Default: 'True'
    AllowedValues:
      - 'False'
      - 'True'
  InstanceAMI:
    Description: AMI for use with the EC2 instances
    Type: String
    Default: ami-b63769a1
    AllowedValues:
      - ami-b63769a1
      - ami-cdbdd7a2
  DBInstanceId:
    Description: The RDS DB Instance Identifier
    Type: String
    Default: rds-mysql-inst01
    ConstraintDescription: Must be a valid RDS instance ID
  DBName:
    Description: The RDS DB Instance Name
    Type: String
    Default: wpdb01
    ConstraintDescription: No Special Characters
  DBEngine:
    Description: The RDS DB Engine Type
    Type: String
    Default: MySQL
    ConstraintDescription: Must be a valid RDS Engine Type
  DBUserName:
    Description: The RDS DB Instance UserName
    Type: String
    Default: dbuser
    ConstraintDescription: No Special Characters
  DBUserPass:
    Description: The RDS DB Instance Password
    Type: String
    Default: dbuserpass
    ConstraintDescription: Choose wisely
  DBStorage:
    Description: The RDS DB Size in GB
    Type: String
    Default: '20'
    ConstraintDescription: Storage in GBs
  DBInstanceClass:
    Description: The RDS DB Instance Type
    Type: String
    Default: db.t2.micro
    ConstraintDescription: Must be a valid RDS instance Class
Mappings:
  RegionMap:
    us-east-1:
      '64': ami-b63769a1
    ap-south-1:
      '64': ami-cdbdd7a2
Resources:
  myDemoVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock:
        Ref: CidrBlock
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value:
            Ref: 'AWS::StackName'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e4f7936a-400a-4d5c-95f5-f806e02f2c22
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value:
            Ref: 'AWS::StackName'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a8c917ec-ee69-4d4c-a528-c62c4996d5ec
  GatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e21978dd-2217-4279-8b14-5f9046bd5511
  rtb:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      Tags:
        - Key: Name
          Value:
            Ref: 'AWS::StackName'
      VpcId:
        Ref: myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f6688c2b-e6a2-4754-aecc-2c74383a9cba
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: rtb
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 239ce74a-8b21-4a92-b954-63ab3f391083
  pubSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone:
        Ref: pubAvailabilityZone
      CidrBlock:
        Ref: pubSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            'Fn::Join':
              - '-'
              - - Ref: 'AWS::StackName'
                - Ref: pubAvailabilityZone
      VpcId: !Ref myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 82ca94fc-931b-4a58-b519-765807f6247c
  privSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone:
        Ref: privAvailabilityZone
      CidrBlock:
        Ref: privSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            'Fn::Join':
              - '-'
              - - Ref: 'AWS::StackName'
                - Ref: privAvailabilityZone
      VpcId: !Ref myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: fbe3d8f8-2eab-4167-9f63-026ed5fdaa14
  pubSubnetAssoc:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId:
        Ref: rtb
      SubnetId:
        Ref: pubSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d32ea858-5c74-4048-b38f-e4cfbfd90195
  privSubnetAssoc:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId:
        Ref: rtb
      SubnetId:
        Ref: privSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b3d2b830-2575-40cc-a9b3-352ffff45f9a
  WebSecGrp:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable SSH & HTTPD access via port 22 & 80 respectively
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
      VpcId: !Ref myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 7568faca-cd6b-4340-a8fb-b0911c92c760
  DBSecGrp:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Frontend Access - Enable EC2 to access RDS(MySQL) access via port 3306
      VpcId: !Ref myDemoVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9f2904d4-266b-42c3-8399-76d965243f04
  DBInboundRule:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      IpProtocol: tcp
      FromPort: '3306'
      ToPort: '3306'
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - WebSecGrp
          - GroupId
      GroupId:
        'Fn::GetAtt':
          - DBSecGrp
          - GroupId
    Metadata:
      'AWS::CloudFormation::Designer':
        id: aa6894cb-4e89-4a33-bb6a-98a255dbebd4
  DBSubnetGrp:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: The RDS DB Instance Identifier
      SubnetIds:
        - !Ref privSubnet
        - !Ref pubSubnet
      Tags:
        - Key: Name
          Value:
            'Fn::Join':
              - '-'
              - - Ref: 'AWS::StackName'
                - RDS
                - Ref: privAvailabilityZone
    Metadata:
      'AWS::CloudFormation::Designer':
        id: aaff044f-027d-4278-ab17-57f9b88318ed
  webServer:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - 64
      InstanceType: !Ref InstanceType
      SubnetId: !Ref pubSubnet
      SecurityGroupIds:
        - !Ref WebSecGrp
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -x

          yum install -y httpd php php-mysql mysql-server

          systemctl start httpd

          systemctl start mysqld

          groupadd www

          usermod -a -G www ec2-user


          # Download wordpress site & move to http

          cd /var/www/

          curl -O https://wordpress.org/latest.tar.gz && tar -zxf latest.tar.gz

          rm -rf /var/www/html

          mv wordpress /var/www/html


          # Set the permissions

          chown -R root:www /var/www

          chmod 2775 /var/www

          find /var/www -type d -exec chmod 2775 {} +

          find /var/www -type f -exec chmod 0664 {} +


          # SE Linux permissive

          # needed to make wp connect to DB over newtork

          setsebool -P httpd_can_network_connect=1

          setsebool httpd_can_network_connect_db on


          echo "<h1> Welcome to Valaxy Cloudformation Demo</h1>" >>
          /var/www/html/index.html
    Metadata:
      'AWS::CloudFormation::Designer':
        id: da5c168f-8660-4399-a08f-5f2b48d85a7d
  Hadoopworker:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - 64
      InstanceType: !Ref InstanceType
      SubnetId: !Ref privSubnet
      SecurityGroupIds:
        - !Ref DBSecGrp
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -x

          yum install -y httpd php php-mysql mysql-server

          systemctl start httpd

          systemctl start mysqld

          groupadd www

          usermod -a -G www ec2-user


          # Download wordpress site & move to http

          cd /var/www/

          curl -O https://wordpress.org/latest.tar.gz && tar -zxf latest.tar.gz

          rm -rf /var/www/html

          mv wordpress /var/www/html


          # Set the permissions

          chown -R root:www /var/www

          chmod 2775 /var/www

          find /var/www -type d -exec chmod 2775 {} +

          find /var/www -type f -exec chmod 0664 {} +


          # SE Linux permissive

          # needed to make wp connect to DB over newtork

          setsebool -P httpd_can_network_connect=1

          setsebool httpd_can_network_connect_db on


          echo "<h1> Welcome to Valaxy Cloudformation Demo</h1>" >>
          /var/www/html/index.html   
    Metadata:
      'AWS::CloudFormation::Designer':
        id: fdc57ba6-658d-4271-824b-7c33022144e8
  Hadoopmaster:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - 64
      InstanceType: !Ref InstanceType
      SubnetId: !Ref privSubnet
      SecurityGroupIds:
        - !Ref DBSecGrp
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -x

          yum install -y httpd php php-mysql mysql-server

          systemctl start httpd

          systemctl start mysqld

          groupadd www

          usermod -a -G www ec2-user


          # Download wordpress site & move to http

          cd /var/www/

          curl -O https://wordpress.org/latest.tar.gz && tar -zxf latest.tar.gz

          rm -rf /var/www/html

          mv wordpress /var/www/html


          # Set the permissions

          chown -R root:www /var/www

          chmod 2775 /var/www

          find /var/www -type d -exec chmod 2775 {} +

          find /var/www -type f -exec chmod 0664 {} +


          # SE Linux permissive

          # needed to make wp connect to DB over newtork

          setsebool -P httpd_can_network_connect=1

          setsebool httpd_can_network_connect_db on


          echo "<h1> Welcome to Valaxy Cloudformation Demo</h1>" >>
          /var/www/html/index.html               
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 8c42d760-4a2b-45a0-9eeb-8a9398ef764d
  DBServer:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier:
        Ref: DBInstanceId
      DBName:
        Ref: DBName
      Engine:
        Ref: DBEngine
      MasterUsername:
        Ref: DBUserName
      MasterUserPassword:
        Ref: DBUserPass
      DBInstanceClass:
        Ref: DBInstanceClass
      AllocatedStorage:
        Ref: DBStorage
      DBSubnetGroupName:
        Ref: DBSubnetGrp
      VPCSecurityGroups:
        - !GetAtt DBSecGrp.GroupId
    DeletionPolicy: Delete
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 89d54c05-7b80-4786-812a-93baea22e268
Outputs:
  WebServerPublicIPAddress:
    Description: The public IP address of the EC2 Instance.
    Value: !GetAtt webServer.PublicDnsName
    Export:
      Name: !Sub '${AWS::StackName}-Public-DNS-Address'
  RDSEndPoint:
    Description: The RDS Endpoint of MySQL DB
    Value: !GetAtt DBServer.Endpoint.Address
